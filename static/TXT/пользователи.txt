–¢–ó

–ï—Å—Ç—å —Å–µ—Ä–≤–µ—Ä –Ω–∞–ø–∏—Å–∞–Ω—ã–π –Ω–∞ NodaJs Express.
–ï—Å—Ç—å –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö MongaDB. –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ö—Ä–∞–Ω—è—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–æ—Ç–µ–ª–∏.
–ï—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –µ-–º–∞–π–ª.

–ó–∞–¥–∞—á–∞ —Å–æ—Å—Ç–æ–∏—Ç –≤ —Ç–æ–º, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –º–æ–≥–ª–∏
–≤–∏–¥–µ—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ –≤–∏–¥–µ carrentUser
–±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.

–í–∞—Ä–∏–∞–Ω—Ç 1: –°–µ—Å—Å–∏–∏ —á–µ—Ä–µ–∑ Cookie (HTTP-only)
üîπ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç —Å–µ—Å—Å–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É HTTP-only cookie —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º —Å–µ—Å—Å–∏–∏.

–ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç cookie.

–°–µ—Ä–≤–µ—Ä –ø–æ cookie –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç currentUser –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ –¥–∞–Ω–Ω—ã–µ.

‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
–ë–µ–∑–æ–ø–∞—Å–Ω–æ: cookie –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –∏–∑ JS (–µ—Å–ª–∏ httpOnly).

–ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ.

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ–º –±—Ä–∞—É–∑–µ—Ä–æ–≤.

‚öôÔ∏è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (Express + MongoDB + express-session):

const session = require('express-session');
const MongoStore = require('connect-mongo');

app.use(session({
  secret: 'yourSecretKey',
  resave: false,
  saveUninitialized: false,
  store: MongoStore.create({ mongoUrl: 'mongodb://localhost:27017/yourDB' }),
  cookie: {
    httpOnly: true,
    secure: false, // true –µ—Å–ª–∏ HTTPS
    maxAge: 1000 * 60 * 60 // 1 —á–∞—Å
  }
}));


–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:

app.post('/register', async (req, res) => {
  const user = await User.create(req.body);
  req.session.userId = user._id;
  res.json({ success: true });
});

–ù–∞ –∫–ª–∏–µ–Ω—Ç–µ:

// –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
fetch('/current-user', { credentials: 'include' })
  .then(res => res.json())
  .then(data => {
    console.log('Current user:', data);
  });


–í–∞—Ä–∏–∞–Ω—Ç 2: JWT –≤ –ø–∞–º—è—Ç–∏ (–±–µ–∑ localStorage)
üîπ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JWT.

–ö–ª–∏–µ–Ω—Ç —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–∫–µ–Ω –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ React state).

–ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ Authorization.

‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫:
–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–∫–µ–Ω —Ç–µ—Ä—è–µ—Ç—Å—è (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å localStorage –∏–ª–∏ cookie).


function HomePage() {
  const storedUser = localStorage.getItem('currentUser');
  const currentUser = storedUser ? JSON.parse(storedUser) : null;

  return (
    <div>
      {currentUser ? (
        <h1>–ü—Ä–∏–≤–µ—Ç, {currentUser.email}</h1>
      ) : (
        <h1>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ</h1>
      )}
    </div>
  );
}

if (response.ok) {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage
      localStorage.setItem('token', data.token);
      localStorage.setItem('currentUser', JSON.stringify(data.user));


      <form id="myForm" method="POST" action="/submit">
  <input type="hidden" name="localData" id="localDataField">
  <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</form>

<script>
  document.getElementById('localDataField').value = localStorage.getItem('myKey');
</script>


–µ—Å—Ç—å <img id='userfoto' src="" >. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Ç—É–¥–∞ —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –∏ –µ—Å–ª–∏ –Ω–µ—Ç, —Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–Ω–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–§–æ—Ç–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤ –≤–∏–¥–µ –ë—ç–π—Å64 —Å—Ç—Ä–æ–∫–∏. –°—Ç–∏–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ –∫—Ä—É–∂–æ–∫.

–µ—Å—Ç—å —Å—Å—ã–ª–∫–∞  link.href = `/user`, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–¥–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ id –æ–±—ä–µ–∫—Ç–∞ user,
–ø–æ–ª—É—á–∏—Ç—å –æ–±—ä–µ–∫—Ç –≤ –±–∞–∑–µ –ú–æ–Ω–≥–æ –î–ë, –∏ –æ—Ç—Ä–µ–Ω–¥–∏—Ç—å–µ–≥–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ user



      <input type="hidden" id="user-data" value="<%= JSON.stringify(user) %>">

      <script src="/js/userfoto.js"></script>

      –ï—Å—Ç—å –∫–æ–¥ 

      <!DOCTYPE html>
<html lang="en">
<%- include('./partials/head.ejs') %>


  <body class="home">
    <%- include('./partials/nav.ejs') %>

      <div style="margin: 50px;">

        <div>username
          <p>
            <%= user.username %>
          </p>
        </div>


        <div>firstName
          <p>
            <%= user.firstName %>
          </p>
        </div>
        <div>lastName
          <p>
            <%= user.lastName %>
          </p>
        </div>

        <div>email
          <p>
            <%= user.email %>
          </p>
        </div>

        <div>foto
          <img src="data:image/png;base64,<%= user.foto %>" width="20%" height="20%" object-fit="cover">

        </div>
        <button id="logout-btn" style="margin-top: 20px;">LogOut</button>
      </div>

      <%- include('./partials/footer.ejs') %>

        <input type="hidden" id="user-data" value="<%= JSON.stringify(user) %>">

        <script>
          const userDataElement = document.getElementById('user-data');
          const user9 = JSON.parse(userDataElement.value);
          localStorage.setItem('currentUser', JSON.stringify(user9));
        </script>

        <script>
          document.getElementById('logout-btn').addEventListener('click', function () {
            // –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
            localStorage.removeItem('currentUser');

            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.location.href = '/';
          });
        </script>

        <style>
          .home {
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 12px;
            background-color: #cfe7ed;
            color: black;
            padding-top: 0;
          }

          .userfoto {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ccc;
          }
        </style>

        <script src="/js/userfoto.js"></script>
  </body>

</html>

–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–≤–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–æ—Ç–æ—Ä–æ–π
–ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Ñ–æ—Ä–º—É edituser.ejs —Å —Ç–µ–º–∏-–∂–µ –ø–æ–ª—è–º–∏, –ø–æ—Å–ª–µ
—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–¥–µ—Ç POST –∑–∞–ø—Ä–æ—Å –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –±–∞–∑–µ –ú–æ–Ω–≥–æ –î–ë,
–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å –∫–æ–¥–æ–º

const register = async (req, res) => {

    const { username, firstName, lastName, email, password: pass, role } = req.body;
    let str64;
    //    str64 = req.file.buffer.toString("base64");
    if (req.file) { str64 = req.file.buffer.toString("base64") }
    else { str64 = "" };

    //   const bodystr64 = req.file.buffer.toString("base64");
    const bodystr64 = str64;


    const message = 'User with this email already exists....';
    const message1 = 'User with this email already exists+++++';

    User
        .findOne({ email })
        .then((user) => {
            if (user) {
                if (user.email === email) {
                    res.render(createPath('register'), { message });
                }
            }
        });


    const salt = await bcrypt.genSalt(10);
    const hash = await bcrypt.hash(pass, salt);
    const curuser = null;
    const user = new User({ username, firstName, lastName, email, password: hash, role, foto: bodystr64 });
    user
        .save()
        .then((user) => res.render(createPath('user'), { user }))
        .catch(() => res.render(createPath('error'), { message1 }));
}
